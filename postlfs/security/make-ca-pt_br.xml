<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
   "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % general-entities SYSTEM "../../general.ent">
  %general-entities;

  <!ENTITY certhost              "https://hg.mozilla.org/">
  <!ENTITY certpath              "/lib/ckfw/builtins/certdata.txt">
  <!ENTITY make-ca-buildsize     "6,6 MB (com todas as dependências em tempo de execução)">
  <!ENTITY make-ca-time          "0,1 SBU (com todas as dependências em tempo de execução)">

  <!ENTITY make-ca-download      "https://github.com/lfs-book/make-ca/releases/download/v&make-ca-version;/make-ca-&make-ca-version;.tar.xz">
  <!ENTITY make-ca-size          "32 KB">
  <!ENTITY make-ca-md5sum        "74f1ad16d7a086ac76e0424fd4dfe67b">
]>

<!--

Direitos autorais (Copyright) da versão modificada traduzida para a 
língua portuguesa escrita e falada no Brasil: (c) 2022, 2023 Jamenson 
Ferreira Espindula de Almeida Melo (<jafesp@gmail.com>).

  Este trabalho de tradução do livro "Beyond Linux From Scratch" é 
  classificado pela Free Software Foundation como sendo uma "versão 
  modificada" do mencionado livro.  Em assim sendo, na qualidade de 
  tradutor, produtor da "versão modificada" e titular dos direitos 
  autorais sobre a versão traduzida para a língua portuguesa do livro 
  "Beyond Linux From Scratch", concede-se a seguinte permissão:

  É concedida permissão para copiar, distribuir e (ou) modificar este 
  livro "Beyond Linux From Scratch", versão traduzida para a língua 
  portuguesa, sob os termos da Licença de Documentação Livre GNU, versão 
  1.3 ou qualquer versão posterior publicada pela Free Software 
  Foundation; sem Seções Invariantes, sem Textos de Capa Frontal e sem 
  Textos de Quarta Capa.  Uma cópia da licença está incluída na seção 
  intitulada "Licença de Documentação Livre GNU".
  
# Atenção: todos os documentos aqui publicados são distribuídos sem qualquer garantia, implícita e (ou) explícita.
  
  Permission is granted to copy, distribute and (or) modify this book 
  "Beyond Linux From Scratch", translated into Brazilian Portuguese, 
  under the terms of the GNU Free Documentation License, Version 1.3 or 
  any later version published by the Free Software Foundation; with no 
  Invariant Sections, no Front-Cover Texts, and no Back-Cover Texts.  A 
  copy of the license is included in the section entitled "GNU Free 
  Documentation License".

# Warning: all the files herein published are released with no warranty, implicit and (or) explicit.

-->

<sect1 id="make-ca" xreflabel="make-ca-&make-ca-version;">
  <?dbhtml filename="make-ca-pt_br.html"?>

  <sect1info>
    <date>$Date$</date>
  </sect1info>

  <title>make-ca-&make-ca-version;</title>
  <indexterm zone="make-ca">
    <primary sortas="a-make-ca">make-ca</primary>
  </indexterm>

  <sect2 role="package">
    <title>Introdução a make-ca</title>

    <para>

      A Infraestrutura de Chave Pública (ICP) é um método para validar a 
      autenticidade de uma, do contrário, desconhecida entidade ao longo 
      de redes de comunicação não confiáveis.  A ICP funciona 
      estabelecendo uma cadeia de confiança, em vez de confiar em cada 
      anfitrião individual ou entidade explicitamente.  Para a 
      finalidade de um certificado apresentado por uma entidade remota 
      ser acreditado, esse certificado precisa apresentar uma cadeia 
      completa de certificados que possa ser validada usando-se o 
      certificado raiz de uma Autoridade Certificadora (AC) que é 
      acreditada pela máquina local.

    </para>

    <para>

      Estabelecer confiança com uma AC envolve validar coisas como 
      endereço da companhia, propriedade, informação de contato, etc., e 
      assegurar que a AC tenha seguido as melhores práticas, tais como 
      se submeter a auditorias periódicas de segurança por 
      investigadores(as) independentes e manter uma sempre disponível 
      lista de revogação de certificado.  Isso está bem fora do escopo 
      do BLFS (como está para a maior parte das distribuições do Linux).  
      A loja de certificado fornecida aqui é tomada a partir da Fundação 
      Mozilla, que estabeleceu políticas de inclusão muito estritas 
      descritas
<ulink url="https://www.mozilla.org/en-US/about/governance/policies/security-group/certs/">aqui</ulink>.

    </para>

  &lfs111_checked;

    <bridgehead renderas="sect3">Informação do Pacote</bridgehead>
    <itemizedlist spacing="compact">
      <listitem>
        <para>
          Transferência (HTTP): <ulink url="&make-ca-download;"/>
        </para>
      </listitem>
      <listitem>
        <para>
          Tamanho da transferência: &make-ca-size;
        </para>
      </listitem>
      <listitem>
        <para>
          Somas de verificação MD5 da transferência: &make-ca-md5sum;
        </para>
      </listitem>
      <listitem>
        <para>
          Espaço em disco estimado exigido: &make-ca-buildsize;
        </para>
      </listitem>
      <listitem>
        <para>
          Tempo de construção estimado: &make-ca-time;
        </para>
      </listitem>
    </itemizedlist>

    <bridgehead renderas="sect3">Dependências do make-ca</bridgehead>

    <bridgehead renderas="sect4">Exigido</bridgehead>

    <para role="required">

      <xref linkend="p11-kit"/> (exigido em tempo de execução para gerar 
      lojas de certificado a partir de âncoras de confiança)

    </para>
    <!-- /usr/bin/trust é necessário para extrair os certificados para /etc/ssl/certs -->

   <bridgehead renderas="sect4">Opcional (tempo de execução)</bridgehead>
    <para role="optional">
      <xref role="runtime" linkend="nss"/> (para gerar um NSSDB compartilhado)
    </para>

    <para condition="html" role="usernotes">Observações de Usuário(a):
    <ulink url='&blfs-wiki;/make-ca'/></para>
  </sect2>

  <sect2 role="installation">
    <title>Instalação do make-ca</title>

    <para>

      O script <application>make-ca</application> baixará e processará 
      os certificados incluídos no arquivo 
      <filename>certdata.txt</filename> para uso como âncoras de confiança 
      para o módulo de confiança <xref linkend="p11-kit"/>.  
      Adicionalmente, gerará lojas de certificado do sistema usadas 
      pelos aplicativos do BLFS (se os aplicativos recomendados e os 
      opcionais estiverem presentes no sistema).  Quaisquer certificados 
      locais armazenados em <filename>/etc/ssl/local</filename> serão 
      importados para ambos: as âncoras de confiança; e as as lojas de 
      certificado geradas (substituindo a confiança do Mozilla).  
      Adicionalmente, quaisquer valores de confiança modificados serão 
      copiados a partir das âncoras de confiança para 
      <filename>/etc/ssl/local</filename> antes de quaisquer 
      atualizações, preservando os valores de confiança personalizados 
      que divergirem do Mozilla quando se usar o utilitário 
      <command>trust</command> oriundo do 
      <application>p11-kit</application> para operar sobre a loja de 
      confiança.

    </para>

    <para>

      Para instalar as várias lojas de certificados, primeiro instale o 
      script <application>make-ca</application> no local correto.  Como 
      o(a) usuário(a) <systemitem class="username">root</systemitem>:

    </para>

<screen role="root"><userinput>make install &amp;&amp;
install -vdm755 /etc/ssl/local</userinput></screen>

   <para>

     Como o(a) usuário(a)
<systemitem class="username">root</systemitem>, depois de instalar o
<xref linkend="p11-kit"/>, baixe o fonte do certificado e apronte para 
     uso do sistema com o seguinte comando:

   </para>

    <note>

      <para>

        Se executar-se o script uma segunda vez com a mesma versão do 
        <filename>certdata.txt</filename>, por exemplo, atualizar as 
        lojas quando o <application>make-ca</application> for 
        atualizado; ou para acrescentar lojas adicionais conforme o 
        software solicitante for instalado, [então] substitua a chave 
        <parameter>-g</parameter> pela chave <parameter>-r</parameter> 
        na linha de comando.  Se empacotando, [então] execute 
        <command>make-ca --help</command> para ver todas as opções de 
        linha de comando disponíveis.

      </para>

    </note>

<screen role="root"><userinput>/usr/sbin/make-ca -g</userinput></screen>

    <para>

      Você deveria atualizar periodicamente a loja com o comando acima, 
      seja manualmente, ou via um
<phrase revision="sysv">trabalho do cron.</phrase>
<phrase revision="systemd">temporizador do systemd.  Um temporizador está instalado em
<filename>/usr/lib/systemd/system/update-pki.timer</filename> que, se habilitado, verificará as atualizações semanalmente.</phrase>
<phrase revision="sysv">Se você tiver instalado o <xref linkend="fcron"/> e completado a seção relativa 
      a trabalhos periódicos, [então] execute</phrase> 
<phrase revision="systemd">Execute</phrase> os seguintes comandos, como 
      o(a) usuário(a) <systemitem class="username">root</systemitem>, 
      para
<phrase revision="sysv">criar um trabalho semanal do cron:</phrase>
<phrase revision="systemd">habilitar o temporizador do systemd:</phrase>

    </para>

<screen role="nodump" revision="sysv"><userinput>cat &gt; /etc/cron.weekly/update-pki.sh &lt;&lt; "EOF" &amp;&amp;
<literal>#!/bin/bash
/usr/sbin/make-ca -g</literal>
EOF
chmod 754 /etc/cron.weekly/update-pki.sh</userinput></screen>

<screen role="root" revision="systemd"><userinput>systemctl enable update-pki.timer</userinput></screen>

  </sect2>

  <sect2 role="configuration" id="make-ca-config">
    <title>Configurando o make-ca</title>

    <para>

      Para a maioria dos(as) usuários(as), nenhuma configuração 
      adicional é necessária; entretanto, o arquivo 
      <filename>certdata.txt</filename> padrão fornecido pelo make-ca é 
      obtido a partir da ramificação mozilla-release e é modificado para 
      fornecer uma revisão Mercurial.  Essa será a versão correta para a 
      maior parte dos sistemas.  Existem muitas outras variantes do 
      arquivo disponíveis para uso que poderiam ser preferidas por uma 
      razão ou por outra, incluindo os arquivos embarcados com os 
      produtos da Mozilla neste livro.  RedHat e OpenSUSE, por exemplo, 
      usam a versão inclusa no <xref linkend="nss"/>.  Transferências 
      adicionais do(a) desenvolvedor(a) estão disponíveis nos links 
      inclusos em <filename>/etc/make-ca.conf.dist</filename>.  
      Simplesmente copie o arquivo para 
      <filename>/etc/make-ca.conf</filename> e edite conforme 
      apropriado.

    </para>

    <indexterm zone="make-ca make-ca-config">
      <primary sortas="e-etc-make-ca-conf">/etc/make-ca.conf</primary>
    </indexterm>

    <bridgehead renderas="sect3">Acerca de Argumentos de Confiança</bridgehead>

    <para>

      Existem três tipos de confiança que são reconhecidos pelo script 
      <application>make-ca</application>, SSL/TLS, S/Mime e assinatura 
      de código.  Para o <application>OpenSSL</application>, esses são 
      <parameter>serverAuth</parameter>; 
      <parameter>emailProtection</parameter>; e 
      <parameter>codeSigning</parameter>, respectivamente.  Se um dos 
      três argumentos de confiança for omitido, [então] o certificado nem 
      é acreditado, nem é rejeitado para aquela função.  Os clientes que 
      usarem o <application>OpenSSL</application> ou o 
      <application>NSS</application> encontrando esse certificado 
      apresentarão um aviso para o(a) usuário(a).  Os clientes usando o 
      <application>GnuTLS</application> sem o suporte ao 
      <application>p11-kit</application> não estão cientes dos 
      certificados confiáveis.  Para incluir essa AC nos arquivos 
      <filename>ca-bundle.crt</filename>, 
      <filename>email-ca-bundle.crt</filename> ou 
      <filename>objsign-ca-bundle.crt</filename> (os pacotes legados do 
      <application>GnuTLS</application>), precisa ter os argumentos 
      confiáveis adequados.

    </para>

    <bridgehead renderas="sect3">Acrescentando Certificados de AC Adicionais</bridgehead>

    <para>

      O diretório <filename class="directory">/etc/ssl/local</filename> 
      está disponível para acrescentar certificados de AC adicionais à 
      loja de confiança do sistema.  Esse diretório também é usado para 
      armazenar certificados que foram acrescentados a ou modificados na 
      loja de confiança do sistema pelo <xref linkend="p11-kit"/>, de forma 
      que os valores de confiança sejam mantidos ao longo de atualizações.  
      Os arquivos nesse diretório precisam estar no formato de 
      certificado confiável do <application>OpenSSL</application>.  Os 
      certificados importados usando o utilitário 
      <command>trust</command> originário do <xref linkend="p11-kit"/> 
      utilizarão os valores Uso Estendido de Chave x509 para atribuir 
      valores confiáveis padrão para as âncoras do sistema.

    </para>

    <para>

      Se você precisar substituir os valores de confiança ou, do 
      contrário, precisar criar um certificado de confiança do 
      <application>OpenSSL</application> manualmente a partir de um 
      arquivo codificado PEM comum, [então] você precisa acrescentar 
      argumentos de confiança ao comando do <command>openssl</command> e 
      criar um certificado novo.  Por exemplo, usando as raízes do 
      <ulink url="http://www.cacert.org/">CAcert</ulink>, se você quiser 
      confiar em ambos para todas as três funções, [então] os seguintes 
      comandos criarão os certificados confiáveis do OpenSSL adequados 
      (execute como o(a) usuário(a)
<systemitem class="username">root</systemitem> depois que o
<xref linkend="wget"/> estiver instalado):

    </para>

<screen role="nodump"><userinput>wget http://www.cacert.org/certs/root.crt &amp;&amp;
wget http://www.cacert.org/certs/class3.crt &amp;&amp;
openssl x509 -in root.crt -text -fingerprint -setalias "CAcert Class 1 root" \
        -addtrust serverAuth -addtrust emailProtection -addtrust codeSigning \
        > /etc/ssl/local/CAcert_Class_1_root.pem &amp;&amp;
openssl x509 -in class3.crt -text -fingerprint -setalias "CAcert Class 3 root" \
        -addtrust serverAuth -addtrust emailProtection -addtrust codeSigning \
        > /etc/ssl/local/CAcert_Class_3_root.pem &amp;&amp;
/usr/sbin/make-ca -r</userinput></screen>

    <bridgehead renderas="sect3">Substituindo a Confiança do Mozilla</bridgehead>

    <para>

      Ocasionalmente, possivelmente existam instâncias onde você não 
      concorda com a inclusão do Mozilla de uma autoridade de 
      certificação específica.  Se você gostaria de substituir a 
      confiança padrão de uma AC específica, [então] simplesmente crie 
      uma cópia do certificado existente em
<filename class="directory">/etc/ssl/local</filename> com argumentos de 
      confiança diferentes.  Por exemplo, se você gostaria de desconfiar 
      do arquivo "Makebelieve_CA_Root", [então] execute os seguintes 
      comandos:

    </para>

<screen role="nodump"><userinput>openssl x509 -in /etc/ssl/certs/Makebelieve_CA_Root.pem \
             -text \
             -fingerprint \
             -setalias "Disabled Makebelieve CA Root" \
             -addreject serverAuth \
             -addreject emailProtection \
             -addreject codeSigning \
       > /etc/ssl/local/Disabled_Makebelieve_CA_Root.pem &amp;&amp;
/usr/sbin/make-ca -r</userinput></screen>

  </sect2>

  <sect2 role="content">
    <title>Conteúdo</title>

    <segmentedlist>
      <segtitle>Aplicativo Instalado</segtitle>
      <segtitle>Diretórios Instalados</segtitle>

      <seglistitem>

        <seg>make-ca</seg>

        <seg>/etc/ssl/{certs,local} e /etc/pki/{nssdb,anchors,tls/{certs,java}}</seg>

      </seglistitem>
    </segmentedlist>

   <variablelist>
      <bridgehead renderas="sect3">Descrições Curtas</bridgehead>
      <?dbfo list-presentation="list"?>
      <?dbhtml list-presentation="table"?>

      <varlistentry id="make-ca-bin">
        <term><command>make-ca</command></term>
        <listitem>

          <para>

            é um script de shell que adapta uma versão atual do 
            <filename>certdata.txt</filename> e o apronta para uso como 
            a loja de confiança do sistema

          </para>

          <indexterm zone="make-ca make-ca">
            <primary sortas="b-make-ca">make-ca</primary>
          </indexterm>
        </listitem>
      </varlistentry>
   </variablelist>

  </sect2>

</sect1>
